##MySql数据库开发规范

#### 数据库使用禁忌：

> 禁止在生产服务器用线上程序账号手动对线上数据进行变更操作。邮件中禁止群发应用的DB账号和密码。dev环境禁止连接线上数据库。禁止用线上库做任何测试。

#### 建表规范：
    1. 强制：MySQL字符集utf8mb4，存储引擎采用Innodb。
    1. 强制：每张表的每个字段和表作用需要添加中文注释信息。
    1. ？强制：新建表必须为自增无符号数字类型主键列，主键列不应该被修改；
    1. ？强制：所有字段默认值不允许设置为NULL，请添加NOT NULL属性。
    1. 强制：定义列名时禁止包含mysql关键字。（保留字列表见官方网站）
    1. ？强制：任何数字类型字段如果为非负数，必须指定unsigned修饰符。
    1. 强制：用DECIMAL代替FLOAT和DOUBLE存储精确浮点数。例如与货币、金融相关的数据。
    1. 强制：字段禁止用enum,set,bit数据类型，建议使用TINYINT代替。
    1. ？强制：需要为datatime和timestamp类型指定默认值。
    1. ？强制：禁止使用存储过程、触发器、视图、自定义函数、外键等。
    1. ？强制：禁止使用分区表。
    1. 建议：控制单表数据量 单表不超过2000w，建议不超过500w；
    1. 建议：合理分表：限制单库表数量在300以内，除未来可能的分表除外。
    1. 建议：DB名、表名、字段名，都小写,长度建议不超过15
    1. 建议：控制列数量，字段少而精，字段数量建议在20以内。
    1. 建议：自增列需兼容不连续空洞出现的可能如1,7,15,23。
    1. 建议：字段尽可能不用text/blob类型，换用varchar的性能会比text高很多（避免一次数据指针定位操作）。

#### 索引规范：
    1. 强制：普通索引命名规则："idx_"+字段名称或字段名称缩写，唯一索引命名规则"uniq_"+字段名称或字段名称缩写。
    1. 强制：一个表中，最多可包含8个索引。一个索引中，最多可包含5个列
    1. 强制：不允许建重复索引，冗余索引特殊情况下需要给出明确原因。
    1. 强制：禁止使用全文索引
    1. 强制：长字符字段必须建前缀索引。
    1. 强制：页面搜索严禁左模糊（%XXX）或者全模糊(%XXX%)，如果需要请走搜索引擎来解决。
    1. 建议：索引并非越多越好(能不加就不加，要加的一定得加)；

#### SQL操作规范：
    1. 强制：对同一个表的多次ALTER操作必须合并为一次操作，并禁止使用after修饰符，避免数据重排操作增加线上锁表时间。
    1. 强制：禁止在MySQL的WHERE条件左边对字段进行提升数学运算和函数运算。
    1. 强制：数据库尽量避免做运算操作，计算务必移至业务层。
    1. 强制：禁用跨库查询。
    1. 强制：不允许线上程序做DDL操作。
    1. 强制：select 程序代码中不允许有SELECT * ，需要哪些字段必须明确写明。
    1. 强制：select 程序代码中最多一次SELECT不允许超过5万行记录。
    1. 强制：select 程序代码中单次SELECT执行时间不能超过5秒，建议不超过200ms。
    1. 强制：删除(delete)，变更（update) 语句必须有where条件。
    1. 强制：删除(delete)，变更（update) 语句不使用LIMIT。
    1. 强制：删除(delete)，变更（update) 操作超过1万行记录的表，WHERE条件一定要用到索引。
    1. 强制：删除(delete)，变更（update) 语句单个影响行数不能超过5千行。超过5千的，建议按5千一批分组处理，每处理一批需要SLEEP1秒。并禁止做成并发和多线程。(建议单条SQL更新影响2000条)
    1. 强制：字符比较请使用相同类型和字符集，不同类型比较会发生类型转换无法使用索引，不同字符集比较也将导致无法使用索引。
    1. 强制：禁止使用HINT强制使用索引。
    1. 建议：拒绝3B 拒绝大sql语句：big sql 拒绝大事务：big transaction 拒绝大批量：big batch。以上情况请拆解成小事务，小批量处理。
    1. 建议：OR改写为IN() or的效率是n级别； in的消息时log(n)级别；
    1. 建议：OR改写为UNION，或在程序中去做merge，语句尽量保持简单。
    1. 建议：in的个数建议控制在200以内；
    1. 建议：limit高效分页limit越大，效率越低。建议=采用主键id > $last_selected_id limit 10;
    1. 建议：没有去重需求请使用union all替代union。
    1. 建议：少用join连接；不使用子查询，子查询请转化为JOIN操作。