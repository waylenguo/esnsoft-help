
## 入仓单

1. 生成入仓成本
1. 调整认定成本
1. 自动货票对应（提前到票）
1. 调整出仓成(调整出仓)


### 入仓单第一次生效

```
1. 生成入仓成本
2. 自动货票对应（提前到票）
```

#### 成本明细表

* 描述
> 按入库商品行生成预估成本，包括主成本及非主成本，非主成本数量为0，金额按主成本中数量分摊,最后一次减法。

* 明细表字段说明

|字段名|字段标题|数据来源|用途|说明|
|:------|:------|:------|:------|:------|
|costicode|成本内码|自动生成|||
|costicoder|成本核销内码R|第一次生成时拷贝costicode，红冲时，拷贝原始记录||新增|
|costgroup|成本组|从入仓明细表拷贝|||
|costkey|成本关键字|拷贝costgroup|||
|costtype|成本类型|根据业务单据生成成本配置中定义生成（货值/运费/其他...）|||
|mcostflags|主成本标记|成本类型是主成本时赋值1|用途：程序逻辑中使用，判断该行是主成本||
|mcosttype|主成本类型|当本行是非主成本时赋值为主成本类型||记录主成本类型|
|costkind|成本细类|1010|用途：在移仓时使用|开发程序中使用，数据有哪些？|
|gentype|产生方式|10|          |10：入库单生成，20：发票，30：出库|
|truetype|成本性质|赋值为10预估，根据配置定义是否生成预估|区分预估和真实成本|10:预估；20:真实|
|dc|成本方向|赋值为 1|表示入仓成本| 1:入仓,-1:出仓|
|qtc|签约数量|拷贝自入仓商品行|合同与成本间核销字段||
|qtcunit|成交单位|拷贝自入仓商品行|||
|qty|统计数量|拷贝自入仓商品行|||
|qtyunit|统计单位|拷贝自入仓商品行|||
|fcode|币种|拷贝自采购合同商品行|||
|sfcode|本位币种|拷贝自采购合同商品行|||
|fserate|对本位币汇率|拷贝自采购合同商品行|||
|fcerate|对人民币汇率|拷贝自采购合同商品行|||
|fuerate|对美元汇率|拷贝自采购合同商品行|||
|fcy|原币|根据入仓单签约数量(qtc)*采购合同单价，最后一次减法|||
|scy|本位币|通过原币计算 fcy*fserate，最后一次减法|||
|zcny|折人民币|通过原币计算 fcy*fcerate，最后一次减法|||
|zusd|折美元|通过原币计算 fcy*fuerate，最后一次减法|||
|upric|含税单价|当qtcunit 和 qtyunit 一样时，拷贝自采购合同商品行，含税金额fcy/数量qty|||
|natscy|不含税金额|含税金额scy/（1+增值税率），最后一次减法|||
|natupric|不含税单价|当qtcunit 和 qtyunit 一样时，拷贝自采购合同商品行，否则不含税金额natscy/数量qty|||
|addtaxscy|增值税金额|含税金额-不含税金额，最后一次减法|||
|addtaxrate|增值税税率|拷贝自采购合同商品行|||
|backtaxscy|退税金额|不含税金额*退税率，最后一次减法|||
|backtaxrate|退税率|拷贝自采购合同商品行|||
|costadjustid|成本调整批次号|空|用于标识调整的批次，方便改单处理||
|costadjustidx|成本调整序号|分码服务器生成|用于标识调整的批次，方便改单处理||
|upsheetcode|上游单据号|拷贝自入仓商品行sheetcode|||
|upicode|上游单据主表内码|拷贝自入仓商品行tsicode|||
|upcode|上有单据外码|拷贝自入仓商品行tscode|||
|upgicode|上游子表内码|拷贝自入仓商品行tsgicode|||
|tscode|入出仓单外码|拷贝自入仓商品行tscode|||
|tscoder|入出仓单核销外码|拷贝自入仓商品行tscoder|||
|tsicode|入出仓单内码|拷贝自入仓商品行tsicode|||
|tsgicode|入出仓单商品内码|拷贝自入仓商品tsgicode|||
|tsicoder|入出仓单核销内码|拷贝自入仓商品tsicoder|||
|tsgicoder|入出仓单商品核销内码|拷贝自入仓商品tsgicoder|||
|intscoder|入仓单核销外码|拷贝自入仓商品行intscoder|||
|intsicoder|入仓单核销内码|拷贝自入仓商品intsicoder|||
|intsgicoder|入仓单商品核销内码|拷贝自入仓商品intsgicoder|||
|fintsgicoder|最早入仓单商品内码|拷贝自入仓商品tsgicoder|||
|odate|业务日期|拷贝自入仓商品stockdate|||
|outtsgicode|入仓对应的出仓子项ID|空|||
|purinvicode|采购发票内码|空|||
|purinvicoder|采购发票核销内码|空|||
|purinvcode|采购发票外码|空|||
|purinvcoder|采购发票核销外码|空|||
|purinvgicode|采购发票子表内码|空|||
|purinvgicoder|采购发票子表核销内码|空|||
|salinvicode|销售发票内码|空|||
|salinvicoder|销售发票核销内码|空|||
|salinvcode|销售发票外码|空|||
|salinvcoder|销售发票核销外码|空|||
|salinvgicode|销售发票子表内码|空|||
|salinvgicoder|销售发票子表核销内码|空|||
|costratio|成本分摊比例|xxx|||
|origrate|对原始折算比例|xxx|||
|origqtc|原始签约数量|xxx|||
|origqty|原始统计数量|xxx|||
|xxx|xxx|xxx|||


#### 成本认定余额表

* 描述

> 将入库明细成本按costicoder汇总匹配到认定余额表

* 字段说明

|字段名|字段标题|数据来源|用途|说明|
|:------|:------|:------|:------|:------|
|cmicode|主键，成本明细汇总||||
|costicoder|唯一索引，成本明细汇总|汇总匹配列|||
|cuicode|商户|xxx|||
|fintsgicoder|入仓单商品核销内码(原始)|拷贝自入仓成本明细表|||
|origrate|对原始折算比例|默认值1|给加工成本使用||
|qtcin|签约数量(原始入)|入仓成本明细表汇总|||
|qtcmov|签约数量(移出)|赋值为0|||
|qtcret|签约数量(退货)|赋值为0|||
|qtcinv|签约数量(已认定)| 真是入库成本汇总                |||
|qtcrem|签约数量(待认定)|签约数量(原始入-移出-退货)|||
|qtyin|统计数量(原始入)|入仓成本明细表汇总|||
|qtymov|统计数量(移出)|赋值为0|||
|qtyret|统计数量(退货)|赋值为0|||
|qtyinv|签约数量(已认定)| 真是入库成本汇总                |||
|qtyrem|统计数量(待认定)|统计数量(原始入-移出-退货)|||
|qtyout|统计数量(销售出)|赋值为0|||
|qtybal|统计数量(余额)|统计数量(剩余入-销售出)||暂时没使用到|
|fcyin|原币(原始入)|入仓成本明细表汇总|||
|scyin|本位币(原始入)|入仓成本明细表汇总|||
|zcnyin|报告币1(原始入)|入仓成本明细表汇总|||
|zusdin|报告币2(原始入)|入仓成本明细表汇总|||
|natscyin|不含税本位币(原始入)|入仓成本明细表汇总|||
|addtaxscyin|增值税(原始入)|入仓成本明细表汇总|||
|backtaxscyin|退税金额(原始入)|入仓成本明细表汇总|||



#### 成本结转余额表

* 描述

> 将入库明细成本按汇总匹配列分组求和汇总到结转余额表
> 按匹配列group,其他文本字段max，金额字段sum

* 字段说明

|字段名|字段标题|数据来源|用途|说明|
|:------|:------|:------|:------|:------|
|ctbicode|内码|自动生成|||
|costgroup|成本组|拷贝自入仓成本明细表|            ||
|costkey|成本关键字|拷贝自入仓成本明细表|汇总匹配列||
|costtype|成本类型|拷贝自入仓成本明细表|汇总匹配列||
|mcostflags|主成本标记|拷贝自入仓成本明细表|||
|mcosttype|主成本类型|拷贝自入仓成本明细表|||
|truetype|成本性质|拷贝自入仓成本明细表|汇总匹配列||
|fcode|币种|拷贝自入仓成本明细表|汇总匹配列||
|qtcin|签约数量(入)|入仓成本明细表qtc汇总|||
|qtcout|签约数量(出)|赋值为0|||
|qtcbal|签约数量(余额)| 签约数量(入)-签约数量(出)    |||
|qtcunit|成交单位|拷贝自入仓成本明细表|||
|qtyin|统计数量(入)|入仓成本明细表qty汇总|||
|qtyout|统计数量(出)|赋值为0|||
|qtybal|统计数量(余额)|统计数量(入)-统计数量(出)|||
|qtyunit|统计单位|拷贝自入仓成本明细表|||
|upric|单价|(主成本qtc=0/非主成本fcy=0)插入时 or 明细记录单价不变时直接拷贝成本明细，之后重新计算fcybal/qtybal||移动平均单价|
|natupric|不含税单价|(主成本qtc=0/非主成本fcy=0)插入时or 明细记录单价不变时直接拷贝成本明细，之后重新计算natscybal/qtybal|?出库时余额变化要不要重计算|移动平均单价|
|fserate|对本位币汇率|(主成本qtc=0/非主成本fcy=0)插入时or 明细记录汇率不变时直接拷贝成本明细，之后重新计算 scybal/fcybal|||
|fcerate|对人民币汇率|(主成本qtc=0/非主成本fcy=0)插入时or 明细记录汇率不变时直接拷贝成本明细，之后重新计算 zcnybal/fcybal|||
|fuerate|对美元汇率|(主成本qtc=0/非主成本fcy=0)插入时or 明细记录汇率不变时直接拷贝成本明细，之后重新计算 zusdbal/fcybal|||
|addtaxrate|增值税税率|(主成本qtc=0/非主成本fcy=0)插入时，之后不重新计算|||
|backtaxrate|退税率|(主成本qtc=0/非主成本fcy=0)插入时直接拷贝成本明细，之后不重新计算|||
|fcyin|原币(入)|入仓成本明细表fcy汇总|||
|fcyout|原币(出)|赋值为0|||
|fcybal|原币(余额)|原币(入)-原币(出)|||
|scyin|本位币(入)|入仓成本明细表scy汇总|||
|scyout|本位币(出)|赋值为0|||
|scybal|本位币(余额)|本位币(入)-本位币(出)|||
|zcnyin|报告币1(入)|入仓成本明细表zcny汇总|||
|zcnyout|报告币1(出)|赋值为0|||
|zcnybal|报告币1(余额)|报告币1（入-出）|||
|zusdin|报告币2(入)|入仓成本明细表zusd汇总|||
|zusdout|报告币2(出)|赋值为0|||
|zusdbal|报告币2(余额)|报告币2（入-出）|||
|natscyin|不含税本位币(入)|入仓成本明细表natscy汇总|||
|natscyout|不含税本位币(出)| 赋值为0                      |||
|natscybal|不含税本位币(余额)|不含税本位币(入-出)|||
|addtaxscyin|增值税(入)|入仓成本明细表addtaxscy汇总|||
|addtaxscyout|增值税(出)|赋值为0|||
|addtaxscybal|增值税(余额)|增值税(入-出)|||
|backtaxscyin|退税金额(入)|入仓成本明细表backtaxscy汇总|||
|backtaxscyout|退税金额(出)|赋值为0|||
|backtaxscybal|退税金额(余额)|退税金额(入-出)|||


* 移仓成本
> 移仓成本转移 使用认定算法 可行？ 参见 E:\00项目管理\N9B标准版\01_Documents\04_Design\04_详细设计\03成本\图片2020-3-11

### 入仓单撤单

* 前提

> 一定是没有发票的（自动货票对应的除外）
> 一定是没有出库的
> 被红冲的蓝单不允许撤销

* 描述

```
1. 根据tsicoder，及本单子的sheetcode ,dc=1 删除本单下的入仓成本。（正常入仓+自动货票对应产生的）
2. 根据【1】中被删除记录中的调整id删除利用这个id产生的所有出仓成本明细
3. 将【2】中影响到的出仓单的出仓成本重新调整(调整算法见《出仓调整算法》)
```

#### 成本明细表

> 入仓全部删除
> 出仓重新调整生成

#### 成本认定余额表

> 同入仓

#### 成本结转余额表

> 同入仓

### 入仓单红冲

* 描述

```
1. 红冲掉正常入仓产生的预估成本(按差额，因存在多次红冲，保证每次都产生一条)
2. 红冲掉自动货票对应产生的（红字预估+蓝真实）

```

#### 成本明细表

* 发票直接选择入库的

> 产生差额红冲预估记录，每次红冲时每一个入仓商品行只生成一条红冲记录

* 自动货票对应

> 产生差额红冲预估记录
> 产生差额红冲真实记录

#### 成本认定余额表

> 同入仓

#### 成本结转余额表

> 同入仓

### 入仓单红冲并生成蓝

1. 生成入仓成本
1. 调整认定成本
1. 自动货票对应（提前到票）
1. 调整出仓成(调整出仓)

#### 成本明细表

* 描述

```
1. 红冲单据生效，处理红冲预估成本（同《入仓单红冲》章节）
2. 蓝单生效，生成蓝字入仓预估成本（同标准预估成本生成）
3. 如果已经做过认定，则调整认定成本
4. 如属于自动货票对应情况，则重新自动货票对应
5. 如果已有出仓则调整出库成本。
```

#### 成本认定余额表

> 同入仓

#### 成本结转余额表

> 同入仓

## 采购发票

### 采购发票第一次生效

```
1. 发票认定
2. 出仓调整
```

#### 成本明细表-红预估


* 描述
> 根据采购发票可转真实成本红冲相应预估成本(取最小)

* 明细表字段说明

|字段名|字段标题|数据来源|用途|说明|
|:------|:------|:------|:------|:------|
|costicode|成本内码|自动生成|||
|costgroup|成本组| 拷贝自入仓成本明细最原始那条                                 |||
|costkey|成本关键字|拷贝自入仓成本明细最原始那条|||
|costtype|成本类型|拷贝自入仓成本明细最原始那条|||
|mcostflags|主成本标记|拷贝自入仓成本明细最原始那条|用途：程序逻辑中使用，判断该行是主成本||
|mcosttype|主成本类型|拷贝自入仓成本明细最原始那条||记录主成本类型|
|costkind|成本细类|1110：发票产生|用途：在移仓时使用||
|gentype|产生方式|20？确认程序中是10还是20| 入库单生成，还是发票生成               |后台数据做区分用。|
|truetype|成本性质|赋值为10预估|区分预估和真实成本||
|dc|成本方向|赋值为 1|表示入仓成本| 1:入仓,-1:出仓|
|qtc|签约数量|发票及认定余额表最小值取负数|认定核销字段||
|qtcunit|成交单位|拷贝自入仓成本明细最原始那条|||
|qty|统计数量|当本次qtc小于发票qtc时，使用分摊 本次签约数量qtc/认定余额表中剩余签约数量*认定余额表中剩余统计数量。最后一次减法(发票)|?当本次qtc小于发票qtc时，本次签约数量qtc*发票换算比例。最后一次减法；？发票数量和入库数量可能会一致不。|入库 qtc=3   换算比=3.33,qty=10发票 1   3.33    3.33发票 2   3.33    6.67|
|qtyunit|统计单位|拷贝自入仓成本明细最原始那条|||
|fcode|币种|拷贝自入仓成本明细最原始那条|||
|sfcode|本位币种|拷贝自入仓成本明细最原始那条|||
|fserate|对本位币汇率|拷贝自入仓成本明细最原始那条|||
|fcerate|对人民币汇率|拷贝自入仓成本明细最原始那条|||
|fuerate|对美元汇率|拷贝自入仓成本明细最原始那条|||
|fcy|原币|用qty*认定余额表含税单价最后一次减法|||
|scy|本位币| fcy*frerate，最后一次减法                    ||                                                              |
|zcny|折人民币|fcy*fcerate，最后一次减法|||
|zusd|折美元|fcy*fuerate，最后一次减法|||
|upric|含税单价|含税金额fcy/数量qty|||
|natscy|不含税金额|根据qtc从认定余额表分摊，最后一次减法||分摊还是计算?|
|natupric|不含税单价|不含税金额natscy/数量qty|||
|addtaxscy|增值税金额|含税金额-不含税金额，最后一次减法||分摊还是计算?|
|addtaxrate|增值税税率|拷贝自入仓成本明细最原始那条|||
|backtaxscy|退税金额|根据qtc从认定余额表分摊？不含税金额*退税率，最后一次减法||分摊还是计算?|
|backtaxrate|退税率|拷贝自入仓成本明细最原始那条|||
|costadjustid|成本调整批次号|自动生成|用于标识调整的批次，方便改单处理||
|costadjustidx|成本调整序号|分码服务器生成|用于标识调整的批次，方便改单处理||
|upsheetcode|上游单据号|拷贝自采购发票|||
|upicode|上游单据主表内码|拷贝自采购发票|||
|upcode|上有单据外码|拷贝自采购发票|||
|upgicode|上游子表内码|拷贝自采购发票|||
|tscode|入出仓单外码|拷贝自入仓成本明细最原始那条|||
|tscoder|入出仓单核销外码|拷贝自入仓成本明细最原始那条|||
|tsicode|入出仓单核销内码|拷贝自入仓成本明细最原始那条|||
|tsgicode|入出仓单商品核销内码|拷贝自入仓成本明细最原始那条|||
|tsicoder|入出仓单核销内码|拷贝自入仓成本明细最原始那条|||
|tsgicoder|入出仓单商品核销内码|拷贝自入仓成本明细最原始那条|||
|intscoder|入仓单核销外码|拷贝自入仓成本明细最原始那条|||
|intsicoder|入仓单核销内码|拷贝自入仓成本明细最原始那条|||
|intsgicoder|入仓单商品核销内码|拷贝自入仓成本明细最原始那条|||
|fintsgicoder|最早入仓单商品内码|拷贝自入仓成本明细最原始那条|||
|odate|业务日期|拷贝自采购发票主表开票日期|||
|outtsgicode|入仓对应的出仓子项ID|空|||
|purinvicode|采购发票内码|空|||
|purinvicoder|采购发票核销内码|空|||
|purinvcode|采购发票外码|空|||
|purinvcoder|采购发票核销外码|空|||
|purinvgicode|采购发票子表内码|空|||
|purinvgicoder|采购发票子表核销内码|空|||
|salinvicode|销售发票内码|空|||
|salinvicoder|销售发票核销内码|空|||
|salinvcode|销售发票外码|空|||
|salinvcoder|销售发票核销外码|空|||
|salinvgicode|销售发票子表内码|空|||
|salinvgicoder|销售发票子表核销内码|空|||
|costratio|成本分摊比例|xxx|||
|origrate|对原始折算比例|xxx|||
|origqtc|原始签约数量|xxx|||
|origqty|原始统计数量|xxx|||
|xxx|xxx|xxx|||

#### 成本明细表-蓝真实


* 描述
> 根据采购发票生成真实入库成本

* 明细表字段说明

|字段名|字段标题|数据来源|用途|说明|
|:------|:------|:------|:------|:------|
|costicode|成本内码|自动生成|||
|costgroup|成本组|拷贝自入仓成本明细最原始那条|||
|costkey|成本关键字|costgroup+规则定义重新生成|||
|costtype|成本类型|拷贝自入仓成本明细最原始那条|||
|mcostflags|主成本标记|拷贝自入仓成本明细最原始那条|用途：程序逻辑中使用，判断该行是主成本||
|mcosttype|主成本类型|拷贝自入仓成本明细最原始那条||记录主成本类型|
|costkind|成本细类|1110:真实发票调整|||
|gentype|产生方式|20| 入库单生成，还是发票生成               |后台数据做区分用。|
|truetype|成本性质|赋值为20真实|区分预估和真实成本||
|dc|成本方向|赋值为 1|表示入仓成本| 1:入仓,-1:出仓|
|qtc|签约数量|发票及待认定最小值|成本间核销字段||
|qtcunit|成交单位|拷贝发票商品行|||
|qty|统计数量|qtc发票及待认定最小值,当qtc小于发票qtc时，本次签约数量qtc*发票换算比例。最后一次减法|?||
|qtyunit|统计单位|拷贝发票商品行|||
|fcode|币种|拷贝发票商品行|||
|sfcode|本位币种|拷贝发票商品行|||
|fserate|对本位币汇率|拷贝发票商品行|||
|fcerate|对人民币汇率|拷贝发票商品行|||
|fuerate|对美元汇率|拷贝发票商品行|||
|fcy|原币|当qtc小于发票签约数量时，签约数量*发票含税单价，最后一次减法（从发票中减）|||
|scy|本位币| 原币fcy*对本位币汇率fserate，最后一次减法（从发票中减） |||
|zcny|折人民币|原币fcy*对本位币汇率fcerate，最后一次减法（从发票中减）|||
|zusd|折美元|原币fcy*对本位币汇率fuerate，最后一次减法（从发票中减）|||
|upric|含税单价|含税金额fcy/数量qty|||
|natscy|不含税金额|含税金额scy/（1+增值税率），最后一次减法|||
|natupric|不含税单价|不含税金额natscy/数量qty|||
|addtaxscy|增值税金额|含税金额-不含税金额，最后一次减法||                    |
|addtaxrate|增值税税率| 拷贝发票商品行                                           |||
|backtaxscy|退税金额|不含税金额*退税率，最后一次减法|||
|backtaxrate|退税率|拷贝发票商品行|||
|costadjustid|成本调整批次号|自动生成（红蓝一样）|用于标识调整的批次，方便改单处理||
|costadjustidx|成本调整序号|分码服务器生成（红蓝一样）|用于标识调整的批次，方便改单处理||
|upsheetcode|上游单据号|拷贝自采购发票|||
|upicode|上游单据主表内码|拷贝自采购发票|||
|upcode|上有单据外码|拷贝自采购发票|||
|upgicode|上游子表内码|拷贝自采购发票商品行|||
|tscode|入出仓单外码|拷贝自入仓成本明细最原始那条|||
|tscoder|入出仓单核销外码| 拷贝自入仓成本明细最原始那条                             |||
|tsicode|入出仓单核销内码|拷贝自入仓成本明细最原始那条|||
|tsgicode|入出仓单商品核销内码|拷贝自入仓成本明细最原始那条|||
|tsicoder|入出仓单核销内码|拷贝自入仓成本明细最原始那条|||
|tsgicoder|入出仓单商品核销内码|拷贝自入仓成本明细最原始那条|||
|intscoder|入仓单核销外码|拷贝自入仓成本明细最原始那条|||
|intsicoder|入仓单核销内码|拷贝自入仓成本明细最原始那条|||
|intsgicoder|入仓单商品核销内码|拷贝自入仓成本明细最原始那条|||
|fintsgicoder|最早入仓单商品内码|拷贝自入仓成本明细最原始那条|||
|odate|业务日期|拷贝自采购发票主表开票日期|||
|outtsgicode|入仓对应的出仓子项ID|空|||
|purinvicode|采购发票内码|空|||
|purinvicoder|采购发票核销内码|空|||
|purinvcode|采购发票外码|空|||
|purinvcoder|采购发票核销外码|空|||
|purinvgicode|采购发票子表内码|空|||
|purinvgicoder|采购发票子表核销内码|空|||
|salinvicode|销售发票内码|空|||
|salinvicoder|销售发票核销内码|空|||
|salinvcode|销售发票外码|空|||
|salinvcoder|销售发票核销外码|空|||
|salinvgicode|销售发票子表内码|空|||
|salinvgicoder|销售发票子表核销内码|空|||
|costratio|成本分摊比例|xxx|||
|origrate|对原始折算比例|xxx|||
|origqtc|原始签约数量|xxx|||
|origqty|原始统计数量|xxx|||
|xxx|xxx|xxx|||

#### 成本认定余额表

> 同入仓

#### 成本结转余额表

> 同入仓

### 采购发票撤单

* 描述

```
1. 根据upsheetcode、upicode删除发票认定产生的入仓成本
2. 根据【1】涉及到的调整ID删除调整的出仓成本
3. 并重新调整出仓成本

```

#### 成本明细表

> 删除认定产生的红冲预估及蓝字真实成本
> 删除认定后产生的调整出仓成本
> 产生新的调整出仓明细（差额）

#### 成本认定余额表

> 同入仓

#### 成本结转余额表

> 同入仓

### 采购发票红冲

* 描述
```
1. 根据purinvgicoder、及dc=1 将所有入库明细成本红冲（按差额，因存在多次红冲，保证每次都产生一条，包括红预估及蓝真实)，产生的记录要记录红单子的内码字段
2. 调整出仓成本
```

#### 成本明细表

* 描述

```
1. 产生差额蓝预估入仓成本
2. 产生差额红真实入仓成本
3. 产生新的调整出仓明细（差额）
```
#### 成本认定余额表

> 同入仓

#### 成本结转余额表

> 同入仓

### 采购发票红冲并生成蓝

* 描述

```
0. 同第一次采购发票生效
1. 成本认定
2. 调整出仓成本
```

#### 成本明细表

> 同入仓

#### 成本认定余额表

> 同入仓

#### 成本结转余额表

> 同入仓

## 出仓单

### 出仓单第一次生效

#### 成本明细表

* 描述

> 根据本次出库中涉及到的costgroup，找成本结转余额表结转成本
> 结转顺序先主成本后辅助成本，先真实后预估

* 明细表字段说明

|字段名|字段标题|数据来源|用途|说明|
|:------|:------|:------|:------|:------|
|costicode|成本内码|自动生成|||
|costgroup|成本组|拷贝成本结转余额表|||
|costkey|成本关键字|拷贝成本结转余额表|||
|costtype|成本类型|拷贝成本结转余额表|||
|mcostflags|主成本标记|拷贝成本结转余额表|用途：程序逻辑中使用，判断该行是主成本||
|mcosttype|主成本类型|拷贝成本结转余额表||记录主成本类型|
|costkind|成本细类|1210:销售出仓|||
|gentype|产生方式|30| 出仓生成           |后台数据做区分用。|
|truetype|成本性质|拷贝成本结转余额表|区分预估和真实成本||
|dc|成本方向|赋值为 -1|表示出仓成本| 1:入仓,-1:出仓|
|qtc|签约数量|拷贝自出库表|                                        ||
|qtcunit|成交单位|拷贝自出仓商品行|||
|qty|统计数量|拷贝自出库表|成本分摊核销字段||
|qtyunit|统计单位|拷贝自出仓商品行|||
|fcode|币种|拷贝成本结转余额表|||
|sfcode|本位币种|拷贝自出仓商品行|||
|fserate|对本位币汇率|拷贝自成本结转余额表|||
|fcerate|对人民币汇率|拷贝自成本结转余额表|||
|fuerate|对美元汇率|拷贝自成本结转余额表|||
|fcy|原币|根据统计数量qty*平均单价，最后一次减法（分摊自成本结转）|||
|scy|本位币| 原币*对本位币汇率（fcy*fserate），最后一次减法（自成本结转） ||分摊还是计算？|
|zcny|折人民币|原币*对人民币汇率（fcy*fserate），最后一次减法（自成本结转）||分摊还是计算？|
|zusd|折美元|原币*对美元汇率（fcy*fserate），最后一次减法（自成本结转）||分摊还是计算？|
|upric|含税单价| 拷贝成本结转余额表                        |||
|natscy|不含税金额|含税金额scy/（1+增值税率），最后一次减法（自成本结转）|||
|natupric|不含税单价|拷贝成本结转余额表|||
|addtaxscy|增值税金额|含税金额-不含税金额，最后一次减法（自成本结转）||分摊还是计算？|
|addtaxrate|增值税税率| 拷贝成本结转余额表                                         |||
|backtaxscy|退税金额| 不含税金额*退税率，最后一次减法（自成本结转）  |||
|backtaxrate|退税率|拷贝自成本结转余额表|||
|costadjustid|成本调整批次号|空|用于标识调整的批次，方便改单处理||
|costadjustidx|成本调整序号|空|用于标识调整的批次，方便改单处理||
|upsheetcode|上游单据号|拷贝自出仓商品行|||
|upicode|上游单据主表内码|拷贝自出仓商品行|||
|upcode|上有单据外码| 拷贝自出仓商品行                          |||
|upgicode|上游子表内码|拷贝自出仓商品行|||
|tscode|入出仓单外码|拷贝自出仓商品行|||
|tscoder|入出仓单核销外码| 拷贝自出仓商品行                                 |||
|tsicode|入出仓单核销内码|拷贝自出仓商品行|||
|tsgicode|入出仓单商品核销内码|拷贝自出仓商品行|||
|tsicoder|入出仓单核销内码|拷贝自出仓商品行|||
|tsgicoder|入出仓单商品核销内码|拷贝自出仓商品行|||
|intscoder|入仓单核销外码|拷贝自出仓商品行|||
|intsicoder|入仓单核销内码|拷贝自出仓商品行|||
|intsgicoder|入仓单商品核销内码|拷贝自出仓商品行|||
|fintsgicoder|最早入仓单商品内码|拷贝自出仓商品行|||
|odate|业务日期|拷贝自出仓商品行出库日期|||
|outtsgicode|入仓对应的出仓子项ID|空|||
|purinvicode|采购发票内码|空|||
|purinvicoder|采购发票核销内码|空|||
|purinvcode|采购发票外码|空|||
|purinvcoder|采购发票核销外码|空|||
|purinvgicode|采购发票子表内码|空|||
|purinvgicoder|采购发票子表核销内码|空|||
|salinvicode|销售发票内码|空|||
|salinvicoder|销售发票核销内码|空|||
|salinvcode|销售发票外码|空|||
|salinvcoder|销售发票核销外码|空|||
|salinvgicode|销售发票子表内码|空|||
|salinvgicoder|销售发票子表核销内码|空|||
|costratio|成本分摊比例|xxx|||
|origrate|对原始折算比例|xxx|||
|origqtc|原始签约数量|xxx|||
|origqty|原始统计数量|xxx|||
|xxx|xxx|xxx|||


#### 成本认定余额表

> 同入仓

#### 成本结转余额表

> 同入仓

### 出仓单撤单

1. 删除成本明细
2. 调整出仓(出库是一个平均出法，所以一旦前面有单据更改为了更贴近实际，把其之后的出库也要调整)

#### 成本认定余额表

#### 成本结转余额表

### 出仓单红冲

#### 成本明细表

#### 成本认定余额表

#### 成本结转余额表

### 出仓单红冲并生成蓝

#### 成本明细表

#### 成本认定余额表

#### 成本结转余额表


### 出仓调整算法

* 描述

> 根据upicode,upsheetcode 删除该出仓单下所有的出库成本明细
> 调整同costgroup下的本次出库单成本最小生成序号之后的出库单成本

```
问题1：发票生效调整
	找预估未核销完成的，按出仓单创建日期顺序
问题2：发票撤单调整
        发票产生序号之后，找带有真实，按出仓单创建日期顺序
问题3：发票红冲调整
	 发票产生序号之后，找带有真实，按出仓单创建日期顺序
问题4：入仓红冲并生成蓝调整
	找预估未核销完成的，按出仓单创建日期顺序
问题5：出仓撤单调整
	当有真实的，找预估未核销完成的，按出仓单创建日期顺序
问题6：出仓红冲调整
        当有真实的，找预估未核销完成的，按出仓单创建日期顺序

出库调整算法：当汇总结转余额表后，主成本时：数量余额>0时 不调整。
						    非主成本时：金额余额>0时 不调整。
                          从后往前（倒叙）调整，数量正好为0 多找一个出库
发票1    10       100  ---       
	发票2    20       220
	发票3   100       220     
	220/20=11 
	----
	 真实：发票1撤单
		出库1-（10）    全部真实        106.67	      不调
		                      110
		   +   0               3.33
		出库2-（10）    全部真实       106.67	     调
				0             110
			+	 0             3.33
		出库3-（10）    全部真实	106.66	      调-  
		                      0
		   +   -10                -106.66

1. 找到本次删除的成本明细中调整序号最小值
2. 根据本次删除的成本明细中根据costgroup,dc=1,序号大于【1】中查到的序号所有出库成本明细
3. 将本次删除的成本明细+【2】中查到的成本明细取反内存中重新汇总到结转余额表，目的是把结转余额表还原到出仓成本结转之前的状态（生成临时结转余额））
4. 根据【2】中的成本明细找到所有受到影响的出仓单（最新单据）。
5. 根据【3】中的临时结转余额表对4中的出仓单重新结转，生成新的结转数据
6. 根据【5】结转数据同历史结转数据（已存储到库中的）做差（tgicode,costtype,costkey,truetype为匹配列），产生差额调整数据
7. 【6】中生成的差额调整数据插入到数据库中。
8. 重新汇总结转余额表，认定表。
```



## 成本调试工具

> http://127.0.0.1:1041/N9Bsna/uiinvoke/00/zh_CN/theme0/FT-TRD.AO.Cost.CostFlowExec.html
> classpath:snsoftx/test/cost/CostTestScript-dl-00.01出库撤单(入库100-出库40-销售发票20-出库40红蓝-销售发票红蓝-采购发票20).tac

## 成本讨论结论：

> 2021-4-8：退货换货：睢、刘、李、石、杜亮

1. 内贸、出口、海外入仓单生效根据合同商品行IDR找到未被认定完的采购发票进行自动货票对应，同时处理开票的核销。
1. 做个处理工作台查询（换货）  场景：入100 ，退10，入10，  发票100|
 